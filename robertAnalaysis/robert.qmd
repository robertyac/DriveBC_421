---
title: "Drive BC Network Analysis"
author:
  - name: "Robert Yacovelli"
format:
  html:
    toc: true
    embed-resources: true
    df-print: paged
editor: visual
---

# Data Loading and Initial Cleaning

```{r}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(readr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(igraph))
```

```{r cache=TRUE}
drivebc_data_2023 <- read_csv("../data/drivebc_events_hist_2023.csv")
head(drivebc_data_2023)

colnames(drivebc_data_2023)
```

# Data Cleaning

```{r}
drivebc_data_2023 <- drivebc_data_2023 %>%
  mutate(
    ID = as.character(ID),
    STATUS = as.factor(STATUS),
    HEADLINE = as.character(HEADLINE),
    DESCRIPTION = as.character(DESCRIPTION),
    IVR_MESSAGE = as.character(IVR_MESSAGE),
    EVENT_TYPE = as.factor(EVENT_TYPE),
    EVENT_SUBTYPE = as.factor(EVENT_SUBTYPE),
    SEVERITY = as.factor(SEVERITY),
    CREATED = as.POSIXct(CREATED),
    UPDATED = as.POSIXct(UPDATED),
    TIME_ZONE = as.factor(TIME_ZONE),
    START_DATETIME = as.POSIXct(START_DATETIME),
    OPEN511_DB_UPDATE_TIMESTAMP = as.POSIXct(OPEN511_DB_UPDATE_TIMESTAMP),
    AREA_NAME = as.character(AREA_NAME),
    AREA_ID = as.character(AREA_ID),
    AREA_LINK = as.character(AREA_LINK),
    HEAD_LATITUDE = as.numeric(HEAD_LATITUDE),
    HEAD_LONGITUDE = as.numeric(HEAD_LONGITUDE),
    TAIL_LATITUDE = as.numeric(TAIL_LATITUDE),
    TAIL_LONGITUDE = as.numeric(TAIL_LONGITUDE),
    ROAD_NAME = as.character(ROAD_NAME),
    ROAD_FROM_DESCRIPTION = as.character(ROAD_FROM_DESCRIPTION),
    ROAD_TO_DESCRIPTION = as.character(ROAD_TO_DESCRIPTION),
    ROAD_DIRECTION = as.character(ROAD_DIRECTION)
  )

drivebc_data_2023 <- drivebc_data_2023 %>%
  select(-END_DATETIME, -ROAD_STATE, -ROAD_DELAY)

drivebc_data_2023 <- drivebc_data_2023 %>%
  drop_na(START_DATETIME)

str(drivebc_data_2023)
head(drivebc_data_2023)
```

```{r}
#| label: fig-graph1
#| fig-width: 15
#| fig-height: 13

#  nodes (unique regions and event types)
all_vertices <- unique(c(drivebc_data_2023$AREA_NAME, as.character(drivebc_data_2023$EVENT_TYPE)))

nodes <- data.frame(name = all_vertices, type = ifelse(all_vertices %in% drivebc_data_2023$AREA_NAME, TRUE, FALSE))

# edges (events connecting regions)
edges <- drivebc_data_2023 %>%
  select(AREA_NAME, EVENT_TYPE) %>%
  distinct()

g <- graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)
layout <- layout_as_bipartite(g)

# label positions
V(g)$label.cex <- 0.7
V(g)$label.dist <- .75
V(g)$label.degree <- ifelse(seq_along(V(g)) %% 2 == 0, pi/2, -pi/2)

plot(g, layout = layout, vertex.label = V(g)$name, vertex.size = 3, edge.arrow.size = 0.5, vertex.label.cex = V(g)$label.cex, vertex.label.dist = V(g)$label.dist, vertex.label.degree = V(g)$label.degree)
```